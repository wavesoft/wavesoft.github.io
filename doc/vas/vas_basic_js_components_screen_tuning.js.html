<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: vas/basic/js/components/screen_tuning.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: vas/basic/js/components/screen_tuning.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>
define(

	// Requirements
	[
		"jquery", "jquery-transition-event", "d3", 
		"vas/core/db", "vas/core/ui", "sha1", "vas/config", "vas/media",
		"vas/core/registry", "vas/core/base/components", 
		"vas/core/user", "vas/core/apisocket", 
		"vas/core/liveq/Calculate", "ccl-tracker"
	],

	/**
	 * Basic version of the home screen
	 *
	 * @exports basic/components/explain_screen
	 */
	function($, $te, d3, DB, UI, SHA1, config, Media, R,C, User, APISocket, Calculate, Analytics ) {

		/**
		 * @class
		 * @classdesc The basic home screen
		 */
		var TuningScreen = function( hostDOM ) {
			C.TuningScreen.call(this, hostDOM);

			// Prepare host
			hostDOM.addClass("tuning2");

			// Setup local variables
			this.machineConfigurationsEnabled = {};
			this.machinePartsEnabled = {};
			this.machinePartTunables = {};
			this.observables = [];
			this.values = {};
			this.lastHistograms = [];
			this.markers = {};
			this.focusMachinePartID = null;
			this.popoverPos = {};
			this.popoverVisible = false;

			this.analyticsEstimateTime = 0;

			// Team header
			$('&lt;h1>&lt;span class="highlight">Tuning&lt;/span> The Quantum Machine&lt;/h1>&lt;div class="subtitle">Fiddle with the quantum machine and find the best values&lt;/div>').appendTo(hostDOM);

			// Menu icons
			var btnHost = $('&lt;div class="menu-icon">&lt;/div>').appendTo(hostDOM),
				btnFeedback = $('&lt;div class="navbtn-large navbtn-upper navbtn-feedback">&lt;span class="glyphicon glyphicon-bullhorn">&lt;/span>&lt;div class="title">Feedback&lt;/div>&lt;/div>').appendTo(btnHost),
				btnLogout = $('&lt;div class="navbtn-large navbtn-upper navbtn-log-out">&lt;span class="glyphicon glyphicon-log-out">&lt;/span>&lt;div class="title">Logout&lt;/div>&lt;/div>').appendTo(btnHost),
				btnUpward = $('&lt;div class="navbtn-large navbtn-upper">&lt;span class="glyphicon glyphicon-menu-up icon-direction icon-direction-up">&lt;/span>&lt;span class="glyphicon glyphicon-cog">&lt;/span>&lt;div class="title">Simulation&lt;/div>&lt;/div>').appendTo(btnHost),
				btnForward = $('&lt;div class="navbtn-large navbtn-upper">&lt;span class="glyphicon glyphicon-menu-right icon-direction icon-direction-right">&lt;/span>&lt;span class="glyphicon glyphicon-user">&lt;/span>&lt;div class="title">Status&lt;/div>&lt;/div>').appendTo(btnHost);

			// Register click handlers
			btnFeedback.click((function() {
				this.trigger("feedback", {
					"screen": "tuning"
				});
			}).bind(this));
			btnForward.click((function() {
				this.trigger("displayStatus");
			}).bind(this));
			btnLogout.click((function() {
				this.trigger("logout");
			}).bind(this));
			btnUpward.click((function() {
				this.trigger("displayJobs");
			}).bind(this));

			// Show feedback video when user moves mouse over
			/*
			btnFeedback.mouseenter((function() {
				setTimeout((function() {
					if (!User.isFirstTimeSeen("ui.button.feedback")) {
						User.markFirstTimeAsSeen("ui.button.feedback");
						UI.scheduleTutorial("ui.button.feedback", function() {
						});
					}
				}).bind(this), 500);
			}).bind(this));
			*/

			// Create status frame
			var elmStatus = this.elmStatus = $('&lt;div class="status-frame">&lt;/div>').appendTo(hostDOM),
				eCreditsRow = $('&lt;div class="row-credits">&lt;/div>').appendTo(elmStatus),
				eCreditsLbl = $('&lt;span class="label">Science Points: &lt;/span>').appendTo(eCreditsRow)
				elmStausCredits = $('&lt;span class="value">&lt;/span>').appendTo(eCreditsRow);

			// Update status frame on profile update
			User.on('profile', (function(profile) {

				// Update user credit
				elmStausCredits.text(profile['points']);

				// Update Machine part counters
				var counters = profile['state']['partcounters'] || {};
				this.machine.onMachineCountersUpdated(counters);

			}).bind(this));

			// ---------------------------------
			// Create machine backdrop
			// ---------------------------------

			// Create a machine
			this.machineDOM = $('&lt;div class="fullscreen fx-animated">&lt;/div>').appendTo(hostDOM);
			this.machine = R.instanceComponent("backdrop.machine", this.machineDOM);
			this.forwardVisualEvents( this.machine, { 'left':0, 'top': 0, 'width': '100%', 'height': '100%' } );
			
			// Setup machine
			this.machine.onMachinePartsEnabled({});

			this.machine.on('click', (function(eid, pos) {
				this.showPopover(pos, eid);
			}).bind(this));

			// ---------------------------------
			// Create help message panel
			// ---------------------------------

			// Create a description vrame
			var descFrame = this.descFrame = $('&lt;div class="description-frame visible">&lt;/div>'); //.appendTo(hostDOM);
			this.descTitle = $('&lt;h1>No part selected&lt;/h1>').appendTo(descFrame);
			this.descBody = $('&lt;div>Please move your mouse over a machine part to see more information.&lt;/div>').appendTo(descFrame);

			// Bind listeners
			this.machine.on('hover', (function(id) {
				var details = DB.cache['definitions']['machine-parts'][id];
				this.btnCourse.addClass("disabled").off('click');
				if (details == undefined) {
					this.descTitle.text("Quantum Machine");
					this.descBody.html("Move your mouse over a component in order to see more details.");
				} else {
					if (!this.machinePartsEnabled[id]) {
						this.descTitle.html('&lt;span class="glyphicon glyphicon-lock">&lt;/span> Part Locked');
						this.descBody.html("You don't have enough experience in order to tune this component. Go back to the &lt;em>Knowlege Tree&lt;/em> and unlock new topics.");
					} else {
						this.descTitle.text(details['description']['title']);
						this.descBody.html(details['description']['body']);
						if (details['description']['course']) {
							this.btnCourse
								.removeClass("disabled")
								.off('click')
								.on('click', (function(e) {
									this.trigger("showCourse", details['description']['course']);
								}).bind(this));
						}
					}
				}
			}).bind(this));

			// Create course button
			this.btnCourse = $('&lt;button class="btn-course btn-shaded btn-teal btn-with-icon disabled">&lt;span class="glyphicon glyphicon-book">&lt;/span>&lt;br />Course&lt;/button>').appendTo(descFrame);

			// ---------------------------------
			// Create tuning panel
			// ---------------------------------

			// Prepare tuning panel DOM
			this.tuningMask = $('&lt;div class="fullscreen mask">&lt;/div>').hide().appendTo(hostDOM);
			this.tunableGroup = $('&lt;div class="parameter-group">&lt;/div>').appendTo(this.tuningMask);
			this.tuningMask.click((function() {
				this.hidePopover((function() {
				}).bind(this));
			}).bind(this));

			// Prepare tuning panel with it's blocking frame
			this.tuningPanel = R.instanceComponent("widget.tunable.tuningpanel", this.tunableGroup);
			this.tunableGroup.click(function(e) {
				e.stopPropagation();
				e.preventDefault();
			});

			// Bind events
			this.tuningPanel.on('change', (function(e) {

			}).bind(this));
			this.tuningPanel.on('hover', (function(tunable) {
				this.updateAssistance( tunable );
			}).bind(this));
			this.tuningPanel.on('showBook', (function(book) { // Incoming events 
				this.trigger('showBook', book);
			}).bind(this));
			this.tuningPanel.on('showCourse', (function(course) { // Incoming events 
				this.trigger('showCourse', course);
			}).bind(this));
			this.tuningPanel.on('valueChanged', (function(toValue, fromValue, meta) {

				// Update value
				this.values[meta['name']] = toValue;

				// Forward to machine part
				this.machinePartComponent.onTuningValueChanged( meta['name'], toValue );

				// A tuning value changed
				Analytics.fireEvent("tuning.values.change", {
					'id': meta['name'],
					'scale': Math.abs(fromValue - toValue) / (meta['max'] - meta['min'])
				});

				// Forward event
				User.triggerEvent("tuning.values.change", {
					'parameter': meta['name'],
					'from': fromValue,
					'to': toValue
				});

			}).bind(this));

			// ---------------------------------
			// Create tuning assistance panel
			// ---------------------------------

			// Create a assistance frame
			this.machinePartDOM = $('&lt;div class="machinepart-frame">&lt;/div>').appendTo(hostDOM);
			this.machinePartComponent = R.instanceComponent( "overlay.machinepart", this.machinePartDOM );
			this.adoptEvents(this.machinePartComponent);

			// Hide explain frame
			this.machinePartDOM.css({
				'left': -300
			});

			// Handle machine parts event
			this.machinePartComponent.on('changeValue', (function(k,v) {
				// Update parameter on machine part component
				this.tuningPanel.onParameterChanged(k,v);
			}).bind(this));
			this.machinePartComponent.on('reload', (function() {

				// If we have a focused machine part, reload it
				if (this.focusMachinePartID) {
					User.getPartDetails(this.focusMachinePartID, (function(details) {
						this.setupPopover( details );
					}).bind(this));
				}
				
			}).bind(this));

			// ---------------------------------
			// Create machine types
			// ---------------------------------

			// Get machine components
			var machineOverlay = this.machineDOM.find(".r-machine-overlay");

			// Machine modes
			this.machineConfigModes = [
				"ee", "ppbar"
			];
			this.machineConfigBtns = [
				$('&lt;button class="btn-machine-beam beam-1 btn-shaded btn-green">Electrons&lt;/button>').appendTo(machineOverlay),
				$('&lt;button class="btn-machine-beam beam-2 btn-shaded btn-green">Protons&lt;/button>').appendTo(machineOverlay)
			];
			for (var i=0; i&lt;this.machineConfigBtns.length; i++) {
				this.machineConfigBtns[i].click( (function(configMode) {
					return function() {
						this.setMachineConfiguration(configMode);
					}
				})(this.machineConfigModes[i]).bind(this));
			}
			
			// ---------------------------------
			// Create a control board
			// ---------------------------------

			var controlBoardHost = this.controlBoardHost = $('&lt;div class="control-board">&lt;/div>').appendTo(hostDOM),
				descBoard = $('&lt;div>&lt;/div>').appendTo(controlBoardHost);

			this.btnEstimate = $('&lt;button class="btn-shaded btn-with-icon btn-red">&lt;span class="glyphicon glyphicon-unchecked">&lt;/span>&lt;br />Estimate&lt;/button>').appendTo(descBoard);
			this.btnValidate = $('&lt;button class="btn-shaded btn-with-icon btn-red btn-striped ">&lt;span class="glyphicon glyphicon-expand">&lt;/span>&lt;br />Validate&lt;/button>').appendTo(descBoard);
			this.panelStatus = $('&lt;div class="panel-shaded">---&lt;/div>').appendTo(descBoard);
			this.btnView = $('&lt;button class="btn-shaded btn-with-icon btn-darkblue">&lt;span class="glyphicon glyphicon-dashboard">&lt;/span>&lt;br />View&lt;/button>').appendTo(descBoard);

			// Bind events
			this.btnEstimate.click((function() {
				this.estimateResults();
			}).bind(this));
			this.btnValidate.click((function() {
				this.validateResults();
			}).bind(this));

			// View histograms
			this.btnView.click((function() {

				// Show histograms overlay
				UI.showOverlay("overlay.histograms", (function(com) {
					com.onHistogramsDefined( this.lastHistograms );
				}).bind(this));

			}).bind(this));

			// Create help button
			this.btnHelp = $('&lt;button class="btn-help btn-shaded btn-teal btn-with-icon">&lt;span class="glyphicon glyphicon-bookmark">&lt;/span>&lt;br />Help&lt;/button>').appendTo(this.hostDOM);
			this.btnHelp.click((function() {
				//this.descFrame.toggleClass("visible");
				UI.showHelpOverlay( Media.image("help/01-help-intro.png") )
			}).bind(this));

			// ---------------------------------
			// Register first-time &amp; visual aids
			// ---------------------------------

			R.registerVisualAid("tuning.control.estimate", this.btnEstimate, { "screen": "screen.tuning" });
			R.registerVisualAid("tuning.control.validate", this.btnValidate, { "screen": "screen.tuning" });
			R.registerVisualAid("tuning.control.status", this.panelStatus, { "screen": "screen.tuning" });
			R.registerVisualAid("tuning.control.view", this.btnView, { "screen": "screen.tuning" });
			R.registerVisualAid("tuning.machine.beam", this.machineConfigBtns[1], { "screen": "screen.tuning" });
			R.registerVisualAid("tuning.menu.credits", elmStatus, { "screen": "screen.tuning" });
			R.registerVisualAid("ui.button.feedback", btnFeedback, { "screen": "screen.tuning" });

		}
		TuningScreen.prototype = Object.create( C.TuningScreen.prototype );

		/** 
		 * Hide pop-up
		 */
		TuningScreen.prototype.hidePopover = function(callback) {

			// Hide control board
			this.controlBoardHost.removeClass("visible");

			// Hide machine part component
			this.machinePartComponent.onWillHide((function() {

				// Remove back-blur fx on the machine DOM
				this.machine.onWillShow((function() {
					this.machineDOM.removeClass("fx-backblur").afterTransition((function() {
						this.machine.onShown();
					}).bind(this));
				}).bind(this));

				// Hide assistance panels
				this.machinePartDOM.css({
					'left': -300
				});
				//setTimeout((function() {
				//	this.descFrame.addClass("visible");
				//}).bind(this), 100);

				// Hide element
				this.tunableGroup.addClass("hidden");
				this.tunableGroup.css(this.popoverPos).css({
					'transform': '',
					'oTransform': '',
					'msTransform': '',
					'webkitTransform': '',
					'mozTransform': '',
				})

				// Cleanup upon animation completion
				setTimeout((function() {
					this.tunableGroup.removeClass("animating");
					this.tuningMask.hide();
					if (callback) callback();
				}).bind(this), 200);

				// Fire analytics			
				var expandTime = Analytics.stopTimer("tuning-machine-part");
				Analytics.fireEvent("tuning.machine.expand_time", {
					"id": this.focusMachinePartID,
					"time": expandTime
				});
				User.triggerEvent("tuning.machine.collapse", {
					'part': this.focusMachinePartID,
					'time': expandTime
				});

				// The component is now hidden
				this.machinePartComponent.onHidden();

				// The popover is now invisible
				this.popoverVisible = false;

			}).bind(this));

		}

		/**
		 * Setup popover with the details given
		 */
		TuningScreen.prototype.setupPopover = function(details) {

			// Find out what tunables are in this machine part 
			var machinePartID = this.focusMachinePartID,
				tunables = this.machinePartTunables[machinePartID],
				hasTunables = (tunables &amp;&amp; (tunables.length > 0));

			// Setup tuning panel if we have tunables
			this.tuningPanel.onTuningPanelDefined( details.title, tunables );
			this.tuningPanel.onTuningValuesDefined( this.values );
			this.tuningPanel.onTuningMarkersDefined( this.markers );
			this.machinePartComponent.onTunablesDefined( tunables );
			this.machinePartComponent.onMachinePartDefined( machinePartID, details, this.machinePartsEnabled[machinePartID] );
			this.machinePartComponent.onTuningValuesDefined( this.values );

			// Calculate centered coordinates
			var sz_w = this.tuningPanel.width, 
				sz_h = this.tuningPanel.height,
				tX = this.width * 4/6, 
				tY = this.height / 2 - 100,
				pX = this.width * 1/4, 
				pY = this.height / 2;

			// Wrap inside screen coordinates
			if (tX - sz_w/2 &lt; 0) tX = sz_w/2;
			if (tY - sz_h/2 &lt; 0) tY = sz_h/2;
			if (tX + sz_w/2 > this.width) tX = this.width - sz_w/2;
			if (tY + sz_h/2 > this.height) tY = this.height - sz_h/2;

			// Center screen if no tunables
			if (!hasTunables) {
				pX = this.width / 2;
				//pY -= 40;
				this.tunableGroup.hide();
			} else {
				// Otherwise show animating
				this.tunableGroup.show();
				this.tunableGroup.addClass("animating");

				/*
				// Check if user has not seen the tuning part tutorial
				if (!User.isFirstTimeSeen("tuning.firsttunable")) {

					UI.scheduleTutorial("ui.tuning.firsttunable", function() {
						User.markFirstTimeAsSeen("tuning.firsttunable");
					});
				}
				*/

			}

			// Prepare show sequence
			setTimeout((function() {

				// Display tuning panel if tunables > 0
				if (hasTunables) {

					// Show tuning panel
					this.tuningPanel.onResize(sz_w, sz_h);
					this.tuningPanel.onWillShow((function() {
						// Make element animated
						this.tunableGroup.removeClass("hidden");
						// Add css
						this.tunableGroup.css({
							'left': tX,
							'top': tY
						});				
						// Shown
						this.tuningPanel.onShown();

					}).bind(this));

					// Remove full
					this.machinePartDOM.removeClass("full");

				} else {
					// Add full
					this.machinePartDOM.addClass("full");
				}

				// Display machine Part Component
				this.machinePartComponent.onWillShow((function() {

					// Callback Shown
					this.machinePartComponent.onShown();

					// Move machinePart DOM in place
					this.machinePartDOM.css({
						'left': pX,
						'top' : pY
					});

				}).bind(this));

				// Show the assistance panels
				//this.descFrame.removeClass("visible");

				// Show controlBoardHost if visible
				if (this.machinePartsEnabled[machinePartID]) {
					this.controlBoardHost.addClass("visible").afterTransition((function() {
						setTimeout((function() {

							// Fire first-time interface aids
							if (!this.btnEstimate.hasClass("disabled"))
								UI.showFirstTimeAid("tuning.control.estimate");
							if (!this.btnValidate.hasClass("disabled"))
								UI.showFirstTimeAid("tuning.control.validate");

						}).bind(this), 100);

					}).bind(this));
				} else {
					this.controlBoardHost.removeClass("visible")
				}

				
			}).bind(this), 10);
		}

		/** 
		 * Show popover over the given coordinates
		 */
		TuningScreen.prototype.showPopover = function( pos, machinePartID ) {

			// Keep popover details
			this.popoverPos = pos;
			this.focusMachinePartID = machinePartID;

			// Query machine part details
			User.getPartDetails(machinePartID, (function(details) {

				// Check if this machine part has an introduction course, and
				// prompt the user to show it
				var _showMachineAnimation = (function() {
					if (details['animation']) {

						// Show the prompt once
						if (!User.isFirstTimeSeen("course-" + details['animation'])) {

							// Ask user if he/she wants to take the intro tutorial
							UI.scheduleFlashPrompt(
								details['title'], 
								"Would you like to see a short course explaining this part?", 
								[
									{ 
										"label"    : "Yes, show it!",
									  	"callback" : (function(){
											// Mark introduction sequence as shown
											User.markFirstTimeAsSeen("course-" + details['animation']);
									  		// Trigger the course display
									  		this.trigger("showCourse", details['animation']);
										}).bind(this)
									},
									{
										"label"    : "Later",
										"class"    : "btn-darkblue",
										"callback" : (function(){
											// Mark introduction sequence as shown
											User.markFirstTimeAsSeen("course-" + details['animation']);
											// Show the first-time aid of the course
											UI.showFirstTimeAid("tuning.machinepart.course");
											// We can now show first-time aids on the machine part
											this.machinePartComponent.onShowFirstTimeAids();
										}).bind(this)
									}
								],
								"flash-icons/course.png"
							);

						} else {
							// We can now show first-time aids on the machine part
							this.machinePartComponent.onShowFirstTimeAids();
						}

					} else {
						// We can now show first-time aids on the machine part
						this.machinePartComponent.onShowFirstTimeAids();
					}
				}).bind(this);

				// Check if user has not seen the machine part tutorial
				/*
				if (!User.isFirstTimeSeen("tuning.machinepart")) {
					UI.scheduleTutorial("ui.tuning.machinepart", function() {
						User.markFirstTimeAsSeen("tuning.machinepart");
						_showMachineAnimation();
					});
				} else {
					_showMachineAnimation();
				}
				*/
				_showMachineAnimation();

				// Add back-blur fx on the machine DOM
				this.machine.onWillHide((function() {
					this.machineDOM.addClass("fx-backblur").afterTransition((function() {
						this.machine.onHidden();
					}).bind(this));
				}).bind(this));

				// Apply position
				this.tunableGroup.css(this.popoverPos = pos);

				// Fire analytics
				Analytics.restartTimer("tuning-machine-part");
				Analytics.fireEvent("tuning.machine.expand", {
					"id": machinePartID
				});
				User.triggerEvent("tuning.machine.expand", {
					"part": machinePartID
				});

				// Setup popover
				this.setupPopover( details );

				// Prepare show sequence
				this.tuningMask.show();

				// The popover is now visible
				this.popoverVisible = true;

			}).bind(this));

		}

		/** 
		 * Configure machine for either ee or ppbar
		 */
		TuningScreen.prototype.setMachineConfiguration = function( configMode ) {
			var index = this.machineConfigModes.indexOf( configMode );
			if (index &lt; 0) return;

			// Reset all buttons
			for (var i=0; i&lt;this.machineConfigBtns.length; i++) {
				this.machineConfigBtns[i].removeClass("btn-striped");
			}
			this.machineConfigBtns[index].addClass("btn-striped");

			// Update backdrop machine configuration
			this.machine.onMachineConfigChanged({
				'beam': configMode
			});

		}

		/** 
		 * Take a snapshot of the current values and save on markers
		 */
		TuningScreen.prototype.snapshotMarkers = function() {

			// Save user values
			User.saveSlotValues("L", this.values);

			// Update 'L' markers
			for (k in this.values) {
				if (typeof(this.values[k]) != 'number') continue;
				if (!this.markers[k]) this.markers[k] = {};
				this.markers[k]['L'] = this.values[k];
			}

		}

		/**
		 * Calculate evaluation ID
		 */
		TuningScreen.prototype.getTuneID = function() {

			// Create a string to hash
			var str = "";

			// Summarize
			for (var k in this.values) {
				str += k + "=" + this.values[k].toString() + ",";
			}

			// Checksum
			return SHA1.hash(str);

		}

		/** 
		 * Submit results for estimation
		 */
		TuningScreen.prototype.estimateResults = function() {

			// Commit estimate transaction
			this.analyticsEstimateTime = Analytics.restartTimer("tuning")

			// Forward event
			User.triggerEvent("tuning.values.estimate", {
			});

			// Submit for interpolation
			this.lab.estimateJob( this.values, this.observables );

			// Save user values
			this.snapshotMarkers();

		}

		/** 
		 * Submit results for validation
		 */
		TuningScreen.prototype.validateResults = function() {

			// Commit estimate transaction
			Analytics.fireEvent("tuning.values.will_validate", {
				"id": this.getTuneID(),
				"time": Analytics.restartTimer("tuning"),
				"values": this.values
			});

			// Forward event
			User.triggerEvent("tuning.values.validate", {
			});
			
			// Submit for interpolation
			this.trigger( 'submitParameters', this.values, this.observables );

			// Save user values
			this.snapshotMarkers();

		}

		/** 
		 * Update the assistance panel for the given tunable ID 
		 */
		TuningScreen.prototype.updateAssistance = function( tunable ) {

			// Change title
			this.machinePartComponent.onTunableFocus( tunable );

		}

		/**
		 * Setup lab before showing
		 */
		TuningScreen.prototype.onWillShow = function(cb) {

			// Open/Resume labSocket
			this.lab = APISocket.openLabsocket();
			this.lab.on('error', (function(message, critical) {
				UI.logError( message, critical );
			}).bind(this));
			this.lab.on('histogramsUpdated', (function(histos) {

				// Save last histograms
				this.lastHistograms = histos;

				// Enable view option
				this.btnView.removeClass("disabled");
				UI.showFirstTimeAid("tuning.control.view");

				// Calculate the Chi2 over all histograms
				var chi2 = 0;
				for (var i=0; i&lt;histos.length; i++) {
					var v = Calculate.chi2(histos[i].data, histos[i].ref.data);
					chi2 += v;
				}
				chi2 /= histos.length;

				// Classify and display
				var msg = "Bad",
					claim = "",
					claim_reason = "";

				if (chi2 &lt; 1) {
					msg = "Perfect";
					claim = "perfect";
					claim_reason = "for your excellet guess";
				} else if (chi2 &lt; 2) {
					msg = "Good";
					claim = "good";
					claim_reason = "for your good estimate";
				} else if (chi2 &lt; 4) {
					msg = "Fair";
					claim = "fair";
					claim_reason = "your fair attempt";
				}
				msg += "(" + chi2.toFixed(2) + ")";

				// Print result
				this.panelStatus.text(msg);

				// Place credits claim request
				if (claim != "")
					User.claimCredits("estimate", claim, claim_reason);

				// Fire analytics
				Analytics.fireEvent("tuning.values.estimate", {
					"id": this.getTuneID(),
					"time": this.analyticsEstimateTime,
					"fit": chi2,
					"values": this.values
				});

			}).bind(this));
	
			// If we have a popover visible, trigger update events
			if (this.popoverVisible) {
				this.machinePartComponent.onWillShow((function() {
					// Callback Shown
					this.machinePartComponent.onShown();
				}).bind(this));
			}
			
			// Continue
			cb();

		}

		/** 
		 * Display visual aids when shown
		 */
		TuningScreen.prototype.onShown = function() {

			// Check if user has not seen the intro tutorial
			if (!User.isFirstTimeSeen("tuning.intro")) {
				// Display the intro help screen
				UI.showHelpOverlay( Media.image("help/01-help-intro.png"), function() {
					// Mark introduction sequence as shown
					User.markFirstTimeAsSeen("tuning.intro");
				});
			}

			// Make sure we have a 'tuning' timer
			Analytics.startTimer("tuning");

		}

		/** 
		 * Define the parameters of the machine
		 */
		TuningScreen.prototype.onTuningConfigUpdated = function( tuningConfig ) {

			// ============================
			// Update observables
			// ============================

			// Set the observables trim
			this.observables = tuningConfig.observables;

			// ============================
			// Machine configurations
			// ============================

			// First update enabled machine configurations
			this.machineConfigurationsEnabled = {};
			for (var i=0; i&lt;tuningConfig.configurations.length; i++) {
				var cfgName = tuningConfig.configurations[i];
				this.machineConfigurationsEnabled[cfgName] = true;
			}

			// Then update UI to reflect the configurations
			//if (!this.machineConfigurationsEnabled['sim-interpolate']) {
			//	this.btnEstimate.addClass("disabled");
			//} else {
			User.onConfigChanged("sim-interpolate", (function(isEnabled) {
				if (isEnabled) {
					this.btnEstimate.removeClass("disabled");
					if (this.controlBoardHost.hasClass("visible")) {
						UI.showFirstTimeAid("tuning.control.estimate");
					}
				} else {
					this.btnEstimate.addClass("disabled");
				}
 			}).bind(this));
			//}
			//if (!this.machineConfigurationsEnabled['sim-run']) {
			//	this.btnValidate.addClass("disabled");
			//} else {
			User.onConfigChanged("sim-validate", (function(isEnabled) {
				if (isEnabled) {
					this.btnValidate.removeClass("disabled");
					if (this.controlBoardHost.hasClass("visible")) {
						UI.showFirstTimeAid("tuning.control.validate");
					}
				} else {
					this.btnValidate.addClass("disabled");
				}
			}).bind(this));
			//}

			// Update machine modes
			for (var i=0; i&lt;this.machineConfigBtns.length; i++) {
				this.machineConfigBtns[i].addClass("disabled");
				this.machineConfigBtns[i].removeClass("btn-striped");
			}

			// Enable mode buttons
			var lastMode = "";
			if (this.machineConfigurationsEnabled['beam-ee']) {
				this.machineConfigBtns[0].removeClass("disabled");
				lastMode = "beam-ee";
			}
			if (this.machineConfigurationsEnabled['beam-ppbar']) {
				this.machineConfigBtns[1].removeClass("disabled");
				lastMode = "beam-ppbar";
			}
			this.setMachineConfiguration(lastMode.substr(5));

			// ============================
			// Machine parts &amp; Tunables
			// ============================

			// Reset tunable values
			this.values = {};
			this.markers = {};

			// First update enabled machine parts
			this.machinePartsEnabled = {};
			for (var i=0; i&lt;tuningConfig.machineParts.length; i++) {
				var partName = tuningConfig.machineParts[i].part,
					tunables = tuningConfig.machineParts[i].tunables;
				this.machinePartsEnabled[partName] = true;
				this.machinePartTunables[partName] = tunables;

				// Place tunable values on map
				for (var j=0; j&lt;tunables.length; j++) {
					this.values[tunables[j]['name']] = tunables[j]['default'] || tunables[j]['min'] || 0.0;
				}
			}

			// Then update interface
			this.machine.onMachinePartsEnabled( this.machinePartsEnabled );

			// ============================
			// Initialize values
			// ============================

			// Get save slot values
			User.getSlotValues("L", (function(values) {
				
				// Prepare markers
				var markers = {};

				// Update local values
				for (k in values) {
					this.values[k] = values[k];
					markers[k] = {
						'L': values[k]
					};
				}

				// Update markers
				this.markers = markers;


			}).bind(this));

			// Reset UI
			this.btnView.addClass("disabled");
			this.panelStatus.text("---");

		}


		// Register home screen
		R.registerComponent( "screen.tuning", TuningScreen, 1 );

	}

);
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-base_components_tuning_observable.html">base/components/tuning/observable</a></li><li><a href="module-base_components_tuning_tunable.html">base/components/tuning/tunable</a></li><li><a href="module-base_components_tuning_tuning_panel.html">base/components/tuning/tuning_panel</a></li><li><a href="module-basic_components_backdrop_explain.html">basic/components/backdrop_explain</a></li><li><a href="module-basic_components_backdrop_globe.html">basic/components/backdrop_globe</a></li><li><a href="module-basic_components_backdrop_home.html">basic/components/backdrop_home</a></li><li><a href="module-basic_components_backdrop_login.html">basic/components/backdrop_login</a></li><li><a href="module-basic_components_backdrop_machine.html">basic/components/backdrop_machine</a></li><li><a href="module-basic_components_backdrop_tuning.html">basic/components/backdrop_tuning</a></li><li><a href="module-basic_components_explain_book.html">basic/components/explain/book</a></li><li><a href="module-basic_components_explain_physics.html">basic/components/explain_physics</a></li><li><a href="module-basic_components_explain_screen.html">basic/components/explain_screen</a></li><li><a href="module-basic_components_nav_mini.html">basic/components/nav_mini</a></li><li><a href="module-basic_components_screem_courseroom.html">basic/components/screem_courseroom</a></li><li><a href="module-basic_components_screem_menu.html">basic/components/screem_menu</a></li><li><a href="module-basic_components_screem_team.html">basic/components/screem_team</a></li><li><a href="module-basic_components_screen_introgame.html">basic/components/screen_introgame</a></li><li><a href="module-basic_components_tvhead_agent.html">basic/components/tvhead_agent</a></li><li><a href="module-core_api_account.html">core/api/account</a></li><li><a href="module-core_api_chatroom.html">core/api/chatroom</a></li><li><a href="module-core_api_course.html">core/api/course</a></li><li><a href="module-core_api_interface.html">core/api/interface</a></li><li><a href="module-core_api_labsocket.html">core/api/labsocket</a></li><li><a href="module-core_api_labtrain.html">core/api/labtrain</a></li><li><a href="module-core_api_team.html">core/api/team</a></li><li><a href="module-core_apisocket.html">core/apisocket</a></li><li><a href="module-core_base_agent.html">core/base/agent</a></li><li><a href="module-core_base_component.html">core/base/component</a></li><li><a href="module-core_base_components.html">core/base/components</a></li><li><a href="module-core_base_data_widget.html">core/base/data_widget</a></li><li><a href="module-core_base_tuning_components.html">core/base/tuning_components</a></li><li><a href="module-core_base_view.html">core/base/view</a></li><li><a href="module-core_data_histogram_meta.html">core/data/histogram_meta</a></li><li><a href="module-core_db.html">core/db</a></li><li><a href="module-core_developer.html">core/developer</a></li><li><a href="module-core_feedback.html">core/feedback</a></li><li><a href="module-core_global.html">core/global</a></li><li><a href="module-core_modules_easing.html">core/modules/easing</a></li><li><a href="module-core_registry.html">core/registry</a></li><li><a href="module-core_ui.html">core/ui</a></li><li><a href="module-core_user.html">core/user</a></li><li><a href="module-core_util_animator.html">core/util/animator</a></li><li><a href="module-core_util_event_base.html">core/util/event_base</a></li><li><a href="module-core_util_math.html">core/util/math</a></li><li><a href="module-core_util_progress_aggregator.html">core/util/progress_aggregator</a></li><li><a href="module-liveq_BufferReader.html">liveq/BufferReader</a></li><li><a href="module-liveq_Calculate.html">liveq/Calculate</a></li><li><a href="module-liveq_HistogramData.html">liveq/HistogramData</a></li><li><a href="module-liveq_LabProtocol.html">liveq/LabProtocol</a></li><li><a href="module-liveq_LabSocket.html">liveq/LabSocket</a></li><li><a href="module-liveq_main.html">liveq/main</a></li><li><a href="module-liveq_ReferenceData.html">liveq/ReferenceData</a></li><li><a href="module-vas-basic_components_onscreen.html">vas-basic/components/onscreen</a></li><li><a href="module-vas-basic_components_running_screen.html">vas-basic/components/running_screen</a></li><li><a href="module-vas-basic_components_screen_bsod.html">vas-basic/components/screen_bsod</a></li><li><a href="module-vas-basic_components_tuning_screen.html">vas-basic/components/tuning_screen</a></li><li><a href="module-vas-basic_data_trainhisto.html">vas-basic/data/trainhisto</a></li><li><a href="module-vas-basic_dataviz_histogram.html">vas-basic/dataviz/histogram</a></li><li><a href="module-vas-basic_dataviz_histogram_full.html">vas-basic/dataviz/histogram_full</a></li><li><a href="module-vas-basic_dataviz_observable.html">vas-basic/dataviz/observable</a></li><li><a href="module-vas-basic_infoblock_knowledge.html">vas-basic/infoblock/knowledge</a></li><li><a href="module-vas-basic_infoblock_observable.html">vas-basic/infoblock/observable</a></li><li><a href="module-vas-basic_infoblock_tunable.html">vas-basic/infoblock/tunable</a></li><li><a href="module-vas-basic_machineparts_describe.html">vas-basic/machineparts/describe</a></li><li><a href="module-vas-basic_machineparts_paper.html">vas-basic/machineparts/paper</a></li><li><a href="module-vas-basic_machineparts_results.html">vas-basic/machineparts/results</a></li><li><a href="module-vas-basic_overlay_buy.html">vas-basic/overlay/buy</a></li><li><a href="module-vas-basic_overlay_feedback.html">vas-basic/overlay/feedback</a></li><li><a href="module-vas-basic_overlay_flash.html">vas-basic/overlay/flash</a></li><li><a href="module-vas-basic_overlay_jobstatus.html">vas-basic/overlay/jobstatus</a></li><li><a href="module-vas-basic_overlay_publicpapers.html">vas-basic/overlay/publicpapers</a></li><li><a href="module-vas-basic_overlay_SwitchTeam.html">vas-basic/overlay/SwitchTeam</a></li><li><a href="module-vas-basic_overlays_help.html">vas-basic/overlays/help</a></li><li><a href="module-vas-basic_profileparts_achievements.html">vas-basic/profileparts/achievements</a></li><li><a href="module-vas-basic_profileparts_books.html">vas-basic/profileparts/books</a></li><li><a href="module-vas-basic_profileparts_papers.html">vas-basic/profileparts/papers</a></li><li><a href="module-vas-basic_profileparts_team.html">vas-basic/profileparts/team</a></li><li><a href="module-vas-basic_profileparts_user.html">vas-basic/profileparts/user</a></li></ul><h3>Classes</h3><ul><li><a href="LiveQ.HistogramData.html">HistogramData</a></li><li><a href="module-basic_components_backdrop_explain-ExplainBackdrop.html">ExplainBackdrop</a></li><li><a href="module-basic_components_backdrop_globe-ObservableScreen.html">ObservableScreen</a></li><li><a href="module-basic_components_backdrop_home-HomeBackdrop.html">HomeBackdrop</a></li><li><a href="module-basic_components_backdrop_home-PaswordReset.html">PaswordReset</a></li><li><a href="module-basic_components_backdrop_login-LoginBackdrop.html">LoginBackdrop</a></li><li><a href="module-basic_components_backdrop_machine-MachineBackdrop.html">MachineBackdrop</a></li><li><a href="module-basic_components_backdrop_tuning-ProgressBackdrop.html">ProgressBackdrop</a></li><li><a href="module-basic_components_backdrop_tuning-ResultsBackdrop.html">ResultsBackdrop</a></li><li><a href="module-basic_components_backdrop_tuning-TuningBackdrop.html">TuningBackdrop</a></li><li><a href="module-basic_components_explain_book-ExplainBook.html">ExplainBook</a></li><li><a href="module-basic_components_explain_physics-ExplainBlackboard.html">ExplainBlackboard</a></li><li><a href="module-basic_components_explain_physics-ExplainPhysics.html">ExplainPhysics</a></li><li><a href="module-basic_components_explain_screen-CinematicScreen.html">CinematicScreen</a></li><li><a href="module-basic_components_explain_screen-HomeScreen.html">HomeScreen</a></li><li><a href="module-basic_components_explain_screen-JobsScreen.html">JobsScreen</a></li><li><a href="module-basic_components_explain_screen-KnowledgeScreen.html">KnowledgeScreen</a></li><li><a href="module-basic_components_explain_screen-StatsTutorial.html">StatsTutorial</a></li><li><a href="module-basic_components_explain_screen-TuningScreen.html">TuningScreen</a></li><li><a href="module-basic_components_nav_mini-NavMini.html">NavMini</a></li><li><a href="module-basic_components_screem_courseroom-CourseroomScene.html">CourseroomScene</a></li><li><a href="module-basic_components_screem_menu-MenuScreen.html">MenuScreen</a></li><li><a href="module-basic_components_screem_team-TeamScreen.html">TeamScreen</a></li><li><a href="module-basic_components_screen_introgame-IntroGameScreen.html">IntroGameScreen</a></li><li><a href="module-basic_components_tvhead_agent-TVhead.html">TVhead</a></li><li><a href="module-core_base_agent-VisualAgent.html">VisualAgent</a></li><li><a href="module-core_base_components-Backdrop.html">Backdrop</a></li><li><a href="module-core_base_components-BookScreen.html">BookScreen</a></li><li><a href="module-core_base_components-BSODScreen.html">BSODScreen</a></li><li><a href="module-core_base_components-CinematicScreen.html">CinematicScreen</a></li><li><a href="module-core_base_components-CourseroomScene.html">CourseroomScene</a></li><li><a href="module-core_base_components-ExplainScreen.html">ExplainScreen</a></li><li><a href="module-core_base_components-HomeScreen.html">HomeScreen</a></li><li><a href="module-core_base_components-IPIDEScreen.html">IPIDEScreen</a></li><li><a href="module-core_base_components-LoginScreen.html">LoginScreen</a></li><li><a href="module-core_base_components-Nav.html">Nav</a></li><li><a href="module-core_base_components-ObservableScreen.html">ObservableScreen</a></li><li><a href="module-core_base_components-PasswordResetScreen.html">PasswordResetScreen</a></li><li><a href="module-core_base_components-Popup.html">Popup</a></li><li><a href="module-core_base_components-ProgressScreen.html">ProgressScreen</a></li><li><a href="module-core_base_components-QuestionaireScreen.html">QuestionaireScreen</a></li><li><a href="module-core_base_components-RegisterScreen.html">RegisterScreen</a></li><li><a href="module-core_base_components-ResultsScreen.html">ResultsScreen</a></li><li><a href="module-core_base_components-RunningScreen.html">RunningScreen</a></li><li><a href="module-core_base_components-TeamScreen.html">TeamScreen</a></li><li><a href="module-core_base_components-TuningScreen.html">TuningScreen</a></li><li><a href="module-core_base_components-TutorialScreen.html">TutorialScreen</a></li><li><a href="module-core_base_component-Component.html">Component</a></li><li><a href="module-core_base_data_widget-DataWidget.html">DataWidget</a></li><li><a href="module-core_base_tuning_components-ObservableWidget.html">ObservableWidget</a></li><li><a href="module-core_base_tuning_components-TunableWidget.html">TunableWidget</a></li><li><a href="module-core_base_tuning_components-TuningPanel.html">TuningPanel</a></li><li><a href="module-core_base_view-View.html">View</a></li><li><a href="module-core_data_histogram_meta-HistogramMetadata.html">HistogramMetadata</a></li><li><a href="module-core_util_animator-Animator.html">Animator</a></li><li><a href="module-core_util_event_base-EventBase.html">EventBase</a></li><li><a href="module-core_util_math-CoreMath.html">CoreMath</a></li><li><a href="module-core_util_progress_aggregator-ProgressAggregator.html">ProgressAggregator</a></li><li><a href="module-liveq_BufferReader-BufferReader.html">BufferReader</a></li><li><a href="module-liveq_HistogramData-HistogramData.html">HistogramData</a></li><li><a href="module-liveq_LabProtocol-LabProtocol.html">LabProtocol</a></li><li><a href="module-liveq_LabSocket-LabSocket.html">LabSocket</a></li><li><a href="module-liveq_ReferenceData-ReferenceData.html">ReferenceData</a></li><li><a href="module-vas-basic_components_running_screen-LoginScreen.html">LoginScreen</a></li><li><a href="module-vas-basic_components_running_screen-ProgressScreen.html">ProgressScreen</a></li><li><a href="module-vas-basic_components_screen_bsod-BSODScreen.html">BSODScreen</a></li><li><a href="module-vas-basic_components_screen_bsod-IPIDEScreen.html">IPIDEScreen</a></li><li><a href="module-vas-basic_dataviz_histogram-PlotHistogram.html">PlotHistogram</a></li><li><a href="Sequencer.html">Sequencer</a></li></ul><h3>Events</h3><ul><li><a href="module-core_api_labsocket-APILabSocket.html#event:connected">connected</a></li><li><a href="module-core_api_labsocket-APILabSocket.html#event:disconnected">disconnected</a></li><li><a href="module-core_api_labsocket-APILabSocket.html#event:error">error</a></li><li><a href="module-core_api_labsocket-APILabSocket.html#event:log">log</a></li><li><a href="module-core_api_labsocket-APILabSocket.html#event:runCompleted">runCompleted</a></li><li><a href="module-core_api_labsocket-APILabSocket.html#event:runError">runError</a></li><li><a href="module-core_api_labsocket-APILabTrain.html#event:completed">completed</a></li><li><a href="module-core_api_labsocket-APILabTrain.html#event:connected">connected</a></li><li><a href="module-core_api_labsocket-APILabTrain.html#event:disconnected">disconnected</a></li><li><a href="module-core_api_labsocket-APILabTrain.html#event:error">error</a></li><li><a href="module-core_api_labsocket-APILabTrain.html#event:log">log</a></li><li><a href="module-core_api_labsocket-APILabTrain.html#event:runError">runError</a></li><li><a href="module-core_base_components-CinematicScreen.html#event:completed">completed</a></li><li><a href="module-core_base_components-ExplainScreen.html#event:explainParameter">explainParameter</a></li><li><a href="module-core_base_components-ExplainScreen.html#event:openGame">openGame</a></li><li><a href="module-core_base_components-ExplainScreen.html#event:openURL">openURL</a></li><li><a href="module-core_base_components-HomeScreen.html#event:changeScreen">changeScreen</a></li><li><a href="module-core_base_components-HomeScreen.html#event:playLevel">playLevel</a></li><li><a href="module-core_base_components-LoginScreen.html#event:login">login</a></li><li><a href="module-core_base_components-RunningScreen.html#event:abortRun">abortRun</a></li><li><a href="module-core_base_components-TuningScreen.html#event:changeParameters">changeParameters</a></li><li><a href="module-core_base_components-TuningScreen.html#event:explainParameter">explainParameter</a></li><li><a href="module-core_base_components-TuningScreen.html#event:submitParameters">submitParameters</a></li><li><a href="module-core_base_data_widget-DataWidget.html#event:valueChanged">valueChanged</a></li><li><a href="module-core_base_data_widget-VisualAgent.html#event:blurVisualAid">blurVisualAid</a></li><li><a href="module-core_base_data_widget-VisualAgent.html#event:completed">completed</a></li><li><a href="module-core_base_data_widget-VisualAgent.html#event:focusVisualAid">focusVisualAid</a></li><li><a href="module-core_base_tuning_components-ObservableWidget.html#event:click">click</a></li><li><a href="module-core_base_tuning_components-ObservableWidget.html#event:hideDetails">hideDetails</a></li><li><a href="module-core_base_tuning_components-ObservableWidget.html#event:showDetails">showDetails</a></li><li><a href="module-core_base_tuning_components-TunableWidget.html#event:click">click</a></li><li><a href="module-core_base_tuning_components-TunableWidget.html#event:hideDetails">hideDetails</a></li><li><a href="module-core_base_tuning_components-TunableWidget.html#event:showDetails">showDetails</a></li><li><a href="module-core_base_tuning_components-TunableWidget.html#event:valueChanged">valueChanged</a></li><li><a href="module-liveq_LabProtocol-LabProtocol.html#event:dataArrived">dataArrived</a></li><li><a href="module-liveq_LabProtocol-LabProtocol.html#event:histogramAdded">histogramAdded</a></li><li><a href="module-liveq_LabProtocol-LabProtocol.html#event:histogramRemoved">histogramRemoved</a></li><li><a href="module-liveq_LabProtocol-LabProtocol.html#event:histogramsUpdated">histogramsUpdated</a></li><li><a href="module-liveq_LabProtocol-LabProtocol.html#event:histogramUpdated">histogramUpdated</a></li><li><a href="module-liveq_LabProtocol-LabProtocol.html#event:metadataUpdated">metadataUpdated</a></li><li><a href="module-liveq_LabProtocol-LabProtocol.html#event:ready">ready</a></li><li><a href="module-liveq_LabSocket-LabSocket.html#event:connected">connected</a></li><li><a href="module-liveq_LabSocket-LabSocket.html#event:disconnected">disconnected</a></li><li><a href="module-liveq_LabSocket-LabSocket.html#event:error">error</a></li><li><a href="module-liveq_LabSocket-LabSocket.html#event:log">log</a></li><li><a href="module-liveq_LabSocket-LabSocket.html#event:runCompleted">runCompleted</a></li><li><a href="module-liveq_LabSocket-LabSocket.html#event:runError">runError</a></li></ul><h3>Namespaces</h3><ul><li><a href="module-liveq_Calculate-Calculate.html">Calculate</a></li></ul><h3>Global</h3><ul><li><a href="global.html#chi2-bounds">chi2-bounds</a></li><li><a href="global.html#core">core</a></li><li><a href="global.html#css">css</a></li><li><a href="global.html#db">db</a></li><li><a href="global.html#dom-host">dom-host</a></li><li><a href="global.html#enforce_http">enforce_http</a></li><li><a href="global.html#forum_vas_api">forum_vas_api</a></li><li><a href="global.html#images_url">images_url</a></li><li><a href="global.html#liveq">liveq</a></li><li><a href="global.html#version">version</a></li><li><a href="global.html#voiceapi">voiceapi</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-beta1</a> on Wed Jul 29 2015 18:29:46 GMT+0200 (CEST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
